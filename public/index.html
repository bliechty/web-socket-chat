<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Socket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!--    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"-->
<!--          integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay"-->
<!--          crossorigin="anonymous">-->
<!--    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">-->
<!--    <script src="action.js" defer></script>-->
<!--    <link rel="stylesheet" href="style.css">-->
</head>
<body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        $(function () {
            let socket = io();
            let timeout;

            function onlineUsersString(id, users) {
                console.log(users);
                let usersString = "<div>Online Users:</div>";
                for (let user of users) {
                    if (id && user.id === id) {
                        usersString += `<div>${user.userName} (you)</div>`;
                    } else {
                        usersString += `<div>${user.userName}</div>`;
                    }
                }
                return usersString;
            }

            socket.emit("connected");

            socket.on("connected", userName => {
                $("#user").val(userName);
            });
            //on form submition emit a "chat message" event to the socket -- to the server
            $("form").submit(function(e){
                e.preventDefault(); // prevents page reloading
                socket.emit("chat message", {msg: $("#m").val(), name: $("#user").val()});
                $("#m").val("");
                return false;
            });
            // listen to the "chat message" on the socket -- coming from the server
            socket.on("chat message", function(msg){
                if (typeof msg === "object") {
                    $("#messages").append($("<li>").text(`Message from ${msg.name}: ${msg.msg}`));
                } else {
                    $("#messages").append($("<li>").text(msg));
                }

                if($("#messages li").length > 5){
                    $("#messages li").eq(0).remove();
                }
            });

            socket.on("user-typing", msg => {
                $("#user-typing").text(msg);
            });

            socket.on("online users", (obj) => {
                $("#online-users").html(onlineUsersString(obj.id, obj.users));
            });

            $("#m").keydown(e => {
                const userName = $("#user").val();
                if (e.key !== "Enter" && e.key !== "Tab" && e.key !== "Meta" && e.key !== "Shift") {
                    socket.emit("user-typing", {
                        msg: `${userName} is typing...`,
                        userName: userName
                    });
                    window.clearTimeout(timeout);
                    timeout = window.setTimeout(() => {
                        socket.emit("user-typing", {
                            msg: "",
                            userName: userName
                        });
                    }, 1500);
                } else if (e.key === "Enter") {
                    socket.emit("user-typing", {
                        msg: "",
                        userName: userName
                    });
                }
            });
        });
    </script>
    <ul id="messages"></ul>
    <div id="user-typing"></div>
    <form action="">
        <span>Name:</span>
        <input id="user" />
        <span>Chat:</span>
        <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <div id="online-users">
    </div>
</body>
</html>